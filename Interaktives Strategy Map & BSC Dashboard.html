<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interaktives Strategy Map & BSC Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/leader-line-new@1.1.9/leader-line.min.js"></script>
    <style>
        :root {
            --color-primary: #003366; --color-background: #F8F9FA; --color-accent-success: #28A745; --color-accent-info: #17A2B8; --color-accent-warning: #FFC107; --color-danger: #dc3545; --color-text-dark: #343A40; --color-text-light: #FFFFFF; --color-border: #dee2e6;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--color-background); color: var(--color-text-dark); margin: 0; padding: 2rem; font-size: 16px; line-height: 1.6; }
        .container { max-width: 1600px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 2rem; background-color: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        h1 { color: var(--color-primary); font-weight: 700; font-size: 2rem; margin: 0; }
        .global-controls { display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; margin-top: 1rem; }
        .dashboard-layout { display: flex; flex-direction: column; gap: 2rem; }
        @media (min-width: 1024px) { .dashboard-layout { flex-direction: row; align-items: flex-start; } }
        .strategy-map-container { flex-grow: 1; position: relative; }
        .details-panel-container { width: 100%; flex-shrink: 0; }
        @media (min-width: 1024px) { .details-panel-container { width: 450px; } }
        .perspective { background-color: white; border-radius: 8px; margin-bottom: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .perspective-header { 
            padding: 1rem 1.5rem; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center;
            background: linear-gradient(to right, #ffffff, #f8f9fa); border-top-left-radius: 8px; border-top-right-radius: 8px;
        }
        .perspective-header h2 { margin: 0; font-size: 1.25rem; color: var(--color-primary); }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 4px; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s, transform 0.1s; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn svg { width: 14px; height: 14px; }
        .btn-info { background-color: var(--color-accent-info); color: var(--color-text-light); }
        .btn-info:hover { background-color: #138496; }
        .objectives-area { padding: 1.5rem; display: flex; flex-wrap: wrap; gap: 1.5rem; min-height: 100px; position: relative; }
        .strategic-objective { background-color: var(--color-background); border: 1px solid var(--color-border); border-left: 4px solid var(--color-primary); border-radius: 4px; padding: 1rem; min-width: 200px; cursor: pointer; transition: all 0.2s; position: relative; display: flex; flex-direction: column; justify-content: space-between; gap: 1rem; z-index: 10; }
        .strategic-objective:hover { box-shadow: 0 6px 12px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .strategic-objective.selected { border-color: var(--color-accent-info); border-left-width: 4px; box-shadow: 0 0 0 3px rgba(23, 162, 184, 0.2); }
        .objective-status { position: absolute; top: 0.5rem; right: 0.5rem; width: 12px; height: 12px; border-radius: 50%; background-color: var(--color-border); }
        .status-green { background-color: var(--color-accent-success); border-color: var(--color-accent-success) !important; } 
        .status-yellow { background-color: var(--color-accent-warning); border-color: var(--color-accent-warning) !important; } 
        .status-red { background-color: var(--color-danger); border-color: var(--color-danger) !important; }
        .objective-controls { display: flex; gap: 0.5rem; }
        .objective-btn { background: none; border: 1px solid var(--color-border); color: #6c757d; font-size: 0.8rem; padding: 0.2rem 0.5rem; border-radius: 4px; cursor: pointer; }
        .objective-btn:hover { background-color: #e9ecef; color: var(--color-text-dark); }
        .details-panel { background-color: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); position: sticky; top: 2rem; }
        .details-panel-placeholder { padding: 4rem 2rem; text-align: center; color: #6c757d; }
        .details-panel-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--color-border); }
        .details-panel-header h3 { margin: 0; font-size: 1.2rem; color: var(--color-primary); }
        .tabs { display: flex; border-bottom: 1px solid var(--color-border); }
        .tab { padding: 1rem 1.5rem; cursor: pointer; border-bottom: 3px solid transparent; color: #6c757d; font-weight: 500; }
        .tab:hover { color: var(--color-primary); }
        .tab.active { color: var(--color-primary); border-bottom-color: var(--color-accent-info); }
        .tab-content { padding: 1.5rem; display: none; }
        .tab-content.active { display: block; }
        .kpi-item, .initiative-item { margin-bottom: 1.5rem; border: 1px solid var(--color-border); padding: 1rem; border-radius: 4px; }
        .kpi-header, .initiative-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .kpi-header h4, .initiative-header h4 { margin: 0; font-size: 1rem; }
        .kpi-progress-bar { width: 100%; height: 8px; background-color: var(--color-background); border-radius: 4px; overflow: hidden; }
        .kpi-progress { height: 100%; background-color: var(--color-accent-success); border-radius: 4px; transition: width 0.3s; }
        .kpi-values { display: flex; justify-content: space-between; font-size: 0.85rem; color: #6c757d; margin-top: 0.25rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 0.75rem; border: 1px solid var(--color-border); border-radius: 4px; font-size: 1rem; box-sizing: border-box; }
        .btn-success { background-color: var(--color-accent-success); color: var(--color-text-light); }
        .btn-success:hover { background-color: #218838; }
        .empty-state { color: #adb5bd; text-align: center; padding: 2rem; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-width: 500px; width: 90%; }
        .modal-content h3 { margin-top: 0; color: var(--color-primary); }
        .modal-buttons { margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 0.5rem; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #5a6268; }
        .container.connecting-mode .strategy-map-container { box-shadow: 0 0 0 3px var(--color-accent-info); border-radius: 8px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(23, 162, 184, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(23, 162, 184, 0); } 100% { box-shadow: 0 0 0 0 rgba(23, 162, 184, 0); } }
        .container.connecting-mode .strategic-objective { cursor: crosshair; }
        .container.connecting-mode .strategic-objective:hover { border-color: var(--color-danger); }
        .explanation-section { background-color: #f8f9fa; border: 1px solid var(--color-border); padding: 0.5rem 1.5rem; margin-bottom: 2rem; border-radius: 4px; }
        .explanation-section summary { cursor: pointer; font-weight: 600; color: var(--color-primary); padding: 0.5rem 0; }
        .explanation-section summary:hover { color: #002244; }
        .explanation-section .content { padding-top: 1rem; padding-bottom: 0.5rem; }
        .explanation-section ul { padding-left: 20px; }
        .container.presentation-mode .objective-controls, .container.presentation-mode .add-objective-btn { display: none; }
        .leader-line { z-index: 1; cursor: pointer; }
    </style>
</head>
<body>

    <div class="container" id="app-container">
        <header>
            <h1>Interaktives Strategy Map & BSC Dashboard</h1>
            <div class="global-controls">
                <button id="presentation-btn" class="btn btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    Präsentationsmodus
                </button>
                <button id="themes-btn" class="btn btn-secondary">Themen verwalten</button>
                <button id="reset-btn" class="btn btn-secondary">Dashboard zurücksetzen</button>
                <button id="export-json-btn" class="btn btn-secondary">Als JSON exportieren</button>
                <button id="import-json-btn" class="btn btn-secondary">Aus JSON importieren</button>
                <input type="file" id="json-upload" style="display: none;" accept="application/json">
            </div>
        </header>

        <details class="explanation-section" open>
            <summary>Einführung, Methode & Anleitung (hier klicken zum Ausklappen)</summary>
            <div class="content">
                <h4>Was ist eine Balanced Scorecard (BSC)?</h4>
                <p>Die Balanced Scorecard (entwickelt von Kaplan & Norton) ist ein Managementsystem, das eine Unternehmensstrategie in messbare Ziele und Kennzahlen (KPIs) übersetzt. Sie betrachtet das Unternehmen aus vier Perspektiven, um eine "ausgewogene" (balanced) Steuerung sicherzustellen.</p>
                <h4>Die Strategy Map: Das Herz der BSC</h4>
                <p>Die Strategy Map visualisiert die Strategie als eine Kette von Ursache-Wirkungs-Beziehungen. Sie zeigt, wie Ziele in der fundamentalen <strong>Lern- & Entwicklungsperspektive</strong> (z.B. Mitarbeiterkompetenz) die Grundlage für exzellente <strong>interne Prozesse</strong> sind, welche wiederum zu einem überzeugenden Nutzenversprechen für die <strong>Kunden</strong> führen und letztlich den <strong>finanziellen</strong> Erfolg ermöglichen.</p>
                <h4>Anleitung für dieses Tool</h4>
                <ul>
                    <li><strong>Ziele & Themen:</strong> Fügen Sie Ziele hinzu oder bearbeiten Sie sie. Unter "Themen verwalten" können Sie strategische Themen (z.B. "Nachhaltigkeit") mit Farben definieren und diese den Zielen zuweisen.</li>
                    <li><strong>Details bearbeiten:</strong> Klicken Sie auf ein Ziel, um rechts das Detail-Panel zu öffnen. Dort können Sie KPIs, Initiativen und eine Beschreibung hinzufügen oder bearbeiten.</li>
                    <li><strong>Ziele verbinden:</strong> Klicken Sie auf den "Verbinden"-Button eines Ziels und anschließend auf ein Ziel in einer höheren Perspektive, um eine Ursache-Wirkungs-Beziehung (Pfeil) zu erstellen. Ein Klick auf einen Pfeil löscht die Verbindung.</li>
                    <li><strong>Speichern & Laden:</strong> Ihr Fortschritt wird automatisch im Browser gespeichert. Nutzen Sie die JSON-Buttons im Header, um Ihre Arbeit als Datei zu sichern.</li>
                </ul>
            </div>
        </details>

        <div class="dashboard-layout">
            <div class="strategy-map-container" id="strategy-map">
                <!-- Perspektiven werden dynamisch von JS gerendert -->
            </div>

            <div class="details-panel-container">
                <div class="details-panel" id="details-panel">
                    <!-- Inhalt wird dynamisch von JS gerendert -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal-Struktur für Eingaben -->
    <div id="form-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title"></h3>
            <div id="modal-body"></div>
            <div class="modal-buttons">
                <button id="modal-cancel" class="btn btn-secondary">Abbrechen</button>
                <button id="modal-save" class="btn btn-success">Speichern</button>
            </div>
        </div>
    </div>

    <script>
    // LeaderLine MUSS global verfügbar sein
    /* global LeaderLine */

    document.addEventListener('DOMContentLoaded', () => {
        const App = {
            // --- 1. ZUSTANDSMANAGEMENT ---
            state: {},

            // --- 2. DOM-REFERENZEN ---
            elements: {
                appContainer: document.querySelector('.container'),
                strategyMap: document.getElementById('strategy-map'),
                detailsPanel: document.getElementById('details-panel'),
                modal: document.getElementById('form-modal'),
                modalTitle: document.getElementById('modal-title'),
                modalBody: document.getElementById('modal-body'),
                modalCancel: document.getElementById('modal-cancel'),
                modalSave: document.getElementById('modal-save'),
                resetBtn: document.getElementById('reset-btn'),
                exportJsonBtn: document.getElementById('export-json-btn'),
                importJsonBtn: document.getElementById('import-json-btn'),
                jsonUpload: document.getElementById('json-upload'),
                themesBtn: document.getElementById('themes-btn'),
                presentationBtn: document.getElementById('presentation-btn'),
            },

            lines: [],
            isStorageAvailable: false,
            lastFocusedElement: null,

            // --- 3. INITIALISIERUNG ---
            init() {
                this.checkStorage();
                if (!this.loadState()) {
                    this.resetStateToDefaults();
                }
                this.render();
                this.attachEventListeners();
            },

            // --- 4. HELPER & UTILITIES ---
            getSelectedObjective() {
                if (!this.state.selectedObjectiveId) return null;
                for (const p of this.state.perspectives) {
                    const obj = p.objectives.find(o => o.id === this.state.selectedObjectiveId);
                    if (obj) return obj;
                }
                return null;
            },

            findObjective(objectiveId) {
                for (const p of this.state.perspectives) {
                    const obj = p.objectives.find(o => o.id === objectiveId);
                    if (obj) return { objective: obj, perspective: p };
                }
                return null;
            },

            calculateKpiStatus(percentage) {
                if (percentage >= 95) return { class: 'status-green', color: 'var(--color-accent-success)' };
                if (percentage >= 75) return { class: 'status-yellow', color: 'var(--color-accent-warning)' };
                return { class: 'status-red', color: 'var(--color-danger)' };
            },

            calculateObjectiveStatus(objective) {
                if (!objective.kpis || objective.kpis.length === 0) return { class: '' };
                const percentages = objective.kpis.map(k => k.target > 0 ? (k.actual / k.target) * 100 : 0);
                const avgPercentage = percentages.reduce((a, b) => a + b, 0) / percentages.length;
                return this.calculateKpiStatus(avgPercentage);
            },
            
            generateUUID() {
                return 'id-' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
            },

            // --- 5. RENDER-FUNKTIONEN ---
            render() {
                this.renderStrategyMap();
                this.renderDetailsPanel();
                setTimeout(() => this.renderConnections(), 50);
            },

            renderStrategyMap() {
                this.elements.strategyMap.innerHTML = '';
                this.state.perspectives.forEach(p => {
                    const perspectiveEl = document.createElement('div');
                    perspectiveEl.className = 'perspective';
                    perspectiveEl.innerHTML = `
                        <div class="perspective-header">
                            <h2>${p.name}</h2>
                            <button class="btn btn-info add-objective-btn" data-perspective-id="${p.id}">Ziel hinzufügen</button>
                        </div>
                        <div class="objectives-area" id="${p.id}"></div>
                    `;
                    const objectivesArea = perspectiveEl.querySelector('.objectives-area');
                    if (p.objectives.length === 0) {
                        objectivesArea.innerHTML = `<div class="empty-state">Fügen Sie hier strategische Ziele hinzu...</div>`;
                    } else {
                        p.objectives.forEach(o => {
                            const objectiveEl = document.createElement('div');
                            const status = this.calculateObjectiveStatus(o);
                            const theme = this.state.themes.find(t => t.id === o.themeId);
                            objectiveEl.className = `strategic-objective ${this.state.selectedObjectiveId === o.id ? 'selected' : ''} ${status.class}`;
                            if (theme) {
                                objectiveEl.style.borderLeftColor = theme.color;
                            }
                            objectiveEl.id = o.id;
                            objectiveEl.innerHTML = `
                                <div>
                                    <span class="objective-status ${status.class}"></span>
                                    ${o.name}
                                </div>
                                <div class="objective-controls">
                                    <button class="objective-btn edit-btn" data-objective-id="${o.id}">Bearbeiten</button>
                                    <button class="objective-btn connect-btn" data-objective-id="${o.id}">Verbinden</button>
                                    <button class="objective-btn delete-btn" data-objective-id="${o.id}">Löschen</button>
                                </div>
                            `;
                            objectiveEl.addEventListener('click', (e) => {
                                if (e.target.classList.contains('objective-btn')) return;
                                this.handleObjectiveSelect(o.id);
                            });
                            objectiveEl.addEventListener('mouseenter', () => this.highlightConnections(o.id, true));
                            objectiveEl.addEventListener('mouseleave', () => this.highlightConnections(o.id, false));
                            objectivesArea.appendChild(objectiveEl);
                        });
                    }
                    this.elements.strategyMap.appendChild(perspectiveEl);
                });
            },
            
            renderDetailsPanel() {
                const selectedObjective = this.getSelectedObjective();
                if (!selectedObjective) {
                    this.elements.detailsPanel.innerHTML = `<div class="details-panel-placeholder"><p>Wählen Sie ein strategisches Ziel aus der Strategy Map aus, um dessen Details anzuzeigen und zu bearbeiten.</p></div>`;
                    return;
                }
                
                this.elements.detailsPanel.innerHTML = `
                    <div class="details-panel-header"><h3>${selectedObjective.name}</h3></div>
                    <div class="tabs">
                        <div class="tab ${this.state.activeTab === 'kpis' ? 'active' : ''}" data-tab="kpis">KPIs</div>
                        <div class="tab ${this.state.activeTab === 'initiatives' ? 'active' : ''}" data-tab="initiatives">Initiativen</div>
                        <div class="tab ${this.state.activeTab === 'description' ? 'active' : ''}" data-tab="description">Beschreibung</div>
                    </div>
                    <div id="kpis-content" class="tab-content ${this.state.activeTab === 'kpis' ? 'active' : ''}"></div>
                    <div id="initiatives-content" class="tab-content ${this.state.activeTab === 'initiatives' ? 'active' : ''}"></div>
                    <div id="description-content" class="tab-content ${this.state.activeTab === 'description' ? 'active' : ''}"></div>
                `;
                this.renderKpiContent(selectedObjective);
                this.renderInitiativeContent(selectedObjective);
                this.renderDescriptionContent(selectedObjective);
            },

            renderKpiContent(objective) {
                const container = document.getElementById('kpis-content');
                if (!container) return;
                
                if (!objective.kpis || objective.kpis.length === 0) {
                    container.innerHTML = `<div class="empty-state">Für dieses Ziel sind keine KPIs definiert.</div>`;
                } else {
                    container.innerHTML = objective.kpis.map(kpi => {
                        const percentage = kpi.target > 0 ? Math.min(100, (kpi.actual / kpi.target) * 100) : 0;
                        const status = this.calculateKpiStatus(percentage);
                        return `
                            <div class="kpi-item">
                                <div class="kpi-header">
                                    <h4>${kpi.name}</h4>
                                    <button class="objective-btn edit-kpi-btn" data-kpi-id="${kpi.id}">Bearbeiten</button>
                                </div>
                                <div class="kpi-progress-bar"><div class="kpi-progress" style="width: ${percentage}%; background-color: ${status.color};"></div></div>
                                <div class="kpi-values"><span>Ist: ${kpi.actual}</span><span>Ziel: ${kpi.target}</span></div>
                            </div>
                        `;
                    }).join('');
                }
                container.innerHTML += `<button class="btn btn-info" id="add-kpi-btn">KPI hinzufügen</button>`;
            },

            renderInitiativeContent(objective) {
                const container = document.getElementById('initiatives-content');
                if (!container) return;
                if (!objective.initiatives || objective.initiatives.length === 0) {
                    container.innerHTML = `<div class="empty-state">Keine Initiativen definiert.</div>`;
                } else {
                    container.innerHTML = objective.initiatives.map(i => `
                        <div class="initiative-item">
                            <div class="initiative-header">
                                <h4>${i.name}</h4>
                                <button class="objective-btn edit-initiative-btn" data-initiative-id="${i.id}">Bearbeiten</button>
                            </div>
                            <p><strong>Verantwortlich:</strong> ${i.responsible}<br>
                            <strong>Status:</strong> ${i.status}</p>
                        </div>
                    `).join('');
                }
                container.innerHTML += `<button class="btn btn-info" id="add-initiative-btn">Initiative hinzufügen</button>`;
            },
            
            renderDescriptionContent(objective) {
                const container = document.getElementById('description-content');
                if (!container) return;
                container.innerHTML = `<p>${objective.description || 'Keine Beschreibung vorhanden.'}</p><button class="btn btn-info" id="edit-desc-btn">Beschreibung bearbeiten</button>`;
            },

            renderConnections() {
                this.lines.forEach(lineInfo => lineInfo.line.remove());
                this.lines = [];
                if (typeof LeaderLine === 'undefined') {
                    console.error("LeaderLine script not loaded.");
                    return;
                }
                this.state.connections.forEach(conn => {
                    const startEl = document.getElementById(conn.from);
                    const endEl = document.getElementById(conn.to);
                    if (startEl && endEl) {
                        try {
                           const line = new LeaderLine(startEl, endEl, { 
                               path: 'fluid',
                               endPlug: 'arrow1',
                               dash: { animation: true }
                           });
                           const lineElement = document.querySelector('.leader-line:last-of-type');
                           if(lineElement) {
                               lineElement.dataset.lineId = conn.id;
                               lineElement.addEventListener('click', () => this.handleDeleteConnection(conn.id));
                           }
                           this.lines.push({line: line, from: conn.from, to: conn.to, id: conn.id});
                        } catch(e) { console.error("LeaderLine Error:", e); }
                    }
                });
            },

            // --- 6. EVENT HANDLER ---
            attachEventListeners() {
                this.elements.strategyMap.addEventListener('click', e => {
                    const target = e.target;
                    if (target.matches('.add-objective-btn')) this.handleShowObjectiveModal(target.dataset.perspectiveId);
                    else if (target.matches('.delete-btn')) this.handleDeleteObjective(target.dataset.objectiveId);
                    else if (target.matches('.connect-btn')) this.handleConnectStart(target.dataset.objectiveId);
                    else if (target.matches('.edit-btn')) this.handleShowObjectiveModal(null, target.dataset.objectiveId);
                });

                this.elements.detailsPanel.addEventListener('click', e => {
                    const target = e.target;
                    if (target.matches('.tab')) this.handleTabClick(target.dataset.tab);
                    else if (target.matches('#add-kpi-btn')) this.handleShowKpiModal();
                    else if (target.matches('.edit-kpi-btn')) this.handleShowKpiModal(target.dataset.kpiId);
                    else if (target.matches('#add-initiative-btn')) this.handleShowInitiativeModal();
                    else if (target.matches('.edit-initiative-btn')) this.handleShowInitiativeModal(target.dataset.initiativeId);
                    else if (target.matches('#edit-desc-btn')) this.handleShowDescriptionModal();
                });

                this.elements.modalCancel.addEventListener('click', () => this.closeModal());
                this.elements.resetBtn.addEventListener('click', () => this.handleShowResetModal());
                this.elements.exportJsonBtn.addEventListener('click', () => this.exportStateAsJson());
                this.elements.importJsonBtn.addEventListener('click', () => this.elements.jsonUpload.click());
                this.elements.jsonUpload.addEventListener('change', e => this.importStateFromJson(e));
                this.elements.themesBtn.addEventListener('click', () => this.handleShowThemesModal());
                this.elements.presentationBtn.addEventListener('click', () => this.elements.appContainer.classList.toggle('presentation-mode'));
                window.addEventListener('resize', () => this.renderConnections());
            },
            
            handleObjectiveSelect(objectiveId) {
                if (this.state.connectingMode.active) {
                    this.handleConnectEnd(objectiveId);
                } else {
                    this.state.selectedObjectiveId = objectiveId;
                    this.render();
                }
            },

            handleTabClick(tabId) {
                this.state.activeTab = tabId;
                this.renderDetailsPanel();
            },

            handleShowObjectiveModal(perspectiveId, objectiveId = null) {
                const isEditing = !!objectiveId;
                const objective = isEditing ? this.findObjective(objectiveId).objective : {};
                const themesOptions = this.state.themes.map(t => `<option value="${t.id}" ${objective.themeId === t.id ? 'selected' : ''}>${t.name}</option>`).join('');
                this.elements.modalTitle.textContent = isEditing ? 'Ziel bearbeiten' : 'Neues strategisches Ziel';
                this.elements.modalBody.innerHTML = `
                    <div class="form-group"><label for="objectiveName">Name des Ziels</label><input type="text" id="objectiveName" value="${objective.name || ''}" placeholder="z.B. Profitabilität steigern"></div>
                    <div class="form-group"><label for="objectiveTheme">Strategisches Thema</label><select id="objectiveTheme"><option value="">Kein Thema</option>${themesOptions}</select></div>
                `;
                this.showModal(() => this.handleSaveObjective(perspectiveId, objectiveId));
            },

            handleShowKpiModal(kpiId = null) {
                const isEditing = !!kpiId;
                const objective = this.getSelectedObjective();
                const kpi = isEditing ? objective.kpis.find(k => k.id === kpiId) : {};
                this.elements.modalTitle.textContent = isEditing ? 'KPI bearbeiten' : 'Neuen KPI hinzufügen';
                this.elements.modalBody.innerHTML = `
                    <div class="form-group"><label for="kpiName">Name des KPI</label><input type="text" id="kpiName" value="${kpi.name || ''}" placeholder="z.B. Net Promoter Score"></div>
                    <div class="form-group"><label for="kpiTarget">Zielwert</label><input type="number" id="kpiTarget" value="${kpi.target || ''}" placeholder="60"></div>
                    <div class="form-group"><label for="kpiActual">Ist-Wert</label><input type="number" id="kpiActual" value="${kpi.actual || ''}" placeholder="45"></div>
                `;
                this.showModal(() => this.handleSaveKpi(kpiId));
            },
            
            handleShowInitiativeModal(initiativeId = null) {
                const isEditing = !!initiativeId;
                const objective = this.getSelectedObjective();
                const initiative = isEditing ? objective.initiatives.find(i => i.id === initiativeId) : {};
                this.elements.modalTitle.textContent = isEditing ? 'Initiative bearbeiten' : 'Neue Initiative';
                this.elements.modalBody.innerHTML = `
                    <div class="form-group"><label for="initiativeName">Name</label><input type="text" id="initiativeName" value="${initiative.name || ''}"></div>
                    <div class="form-group"><label for="initiativeResponsible">Verantwortlich</label><input type="text" id="initiativeResponsible" value="${initiative.responsible || ''}"></div>
                    <div class="form-group"><label for="initiativeStatus">Status</label>
                        <select id="initiativeStatus">
                            <option value="Geplant" ${initiative.status === 'Geplant' ? 'selected' : ''}>Geplant</option>
                            <option value="In Umsetzung" ${initiative.status === 'In Umsetzung' ? 'selected' : ''}>In Umsetzung</option>
                            <option value="Abgeschlossen" ${initiative.status === 'Abgeschlossen' ? 'selected' : ''}>Abgeschlossen</option>
                        </select>
                    </div>
                `;
                this.showModal(() => this.handleSaveInitiative(initiativeId));
            },

            handleShowDescriptionModal() {
                const objective = this.getSelectedObjective();
                this.elements.modalTitle.textContent = 'Beschreibung bearbeiten';
                this.elements.modalBody.innerHTML = `<div class="form-group"><textarea id="objectiveDescription" rows="5">${objective.description || ''}</textarea></div>`;
                this.showModal(() => {
                    objective.description = document.getElementById('objectiveDescription').value;
                    this.closeModal(); this.saveState(); this.renderDetailsPanel();
                });
            },

            handleShowResetModal() {
                this.showConfirmationModal('Dashboard zurücksetzen?', 'Sind Sie sicher? Alle aktuellen und gespeicherten Daten werden gelöscht und das Dashboard wird auf die Beispieldaten zurückgesetzt.', () => {
                    this.resetStateToDefaults();
                    this.closeModal();
                    this.render();
                });
            },

            handleShowThemesModal() {
                this.elements.modalTitle.textContent = 'Strategische Themen verwalten';
                let themesHtml = this.state.themes.map(t => `
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                        <input type="color" value="${t.color}" data-theme-id="${t.id}" class="theme-color-picker">
                        <input type="text" value="${t.name}" data-theme-id="${t.id}" class="theme-name-input" style="flex-grow: 1;">
                        <button class="btn btn-secondary delete-theme-btn" data-theme-id="${t.id}">Löschen</button>
                    </div>
                `).join('');
                this.elements.modalBody.innerHTML = themesHtml + `<button id="add-theme-btn" class="btn btn-info" style="margin-top: 1rem;">Neues Thema</button>`;
                this.showModal(() => {
                    document.querySelectorAll('.theme-name-input').forEach(input => {
                        const theme = this.state.themes.find(t => t.id === input.dataset.themeId);
                        if(theme) theme.name = input.value;
                    });
                    document.querySelectorAll('.theme-color-picker').forEach(input => {
                        const theme = this.state.themes.find(t => t.id === input.dataset.themeId);
                        if(theme) theme.color = input.value;
                    });
                    this.closeModal(); this.saveState(); this.render();
                });
                document.getElementById('add-theme-btn').addEventListener('click', () => {
                    this.state.themes.push({ id: this.generateUUID(), name: 'Neues Thema', color: '#cccccc' });
                    this.handleShowThemesModal();
                });
                this.elements.modalBody.addEventListener('click', e => {
                    if (e.target.classList.contains('delete-theme-btn')) {
                        this.state.themes = this.state.themes.filter(t => t.id !== e.target.dataset.themeId);
                        this.handleShowThemesModal();
                    }
                });
            },

            handleConnectStart(objectiveId) {
                this.state.connectingMode.active = true;
                this.state.connectingMode.startObjectiveId = objectiveId;
                this.elements.appContainer.classList.add('connecting-mode');
            },

            handleConnectEnd(endObjectiveId) {
                const startObjectiveId = this.state.connectingMode.startObjectiveId;
                if (startObjectiveId && endObjectiveId && startObjectiveId !== endObjectiveId) {
                    const startObjInfo = this.findObjective(startObjectiveId);
                    const endObjInfo = this.findObjective(endObjectiveId);
                    const startLevel = this.state.perspectives.findIndex(p => p.id === startObjInfo.perspective.id);
                    const endLevel = this.state.perspectives.findIndex(p => p.id === endObjInfo.perspective.id);

                    if (startLevel > endLevel) { // Correct direction: from lower index to higher index (L&D -> Finance)
                        const exists = this.state.connections.some(c => c.from === startObjectiveId && c.to === endObjectiveId);
                        if (!exists) {
                            this.state.connections.push({ from: startObjectiveId, to: endObjectiveId, id: this.generateUUID() });
                            this.saveState();
                        }
                    } else {
                        alert("Fehler: Verbindungen können nur von einer unteren zu einer oberen Perspektive gezogen werden, um die Ursache-Wirkungs-Logik abzubilden.");
                    }
                }
                this.state.connectingMode.active = false;
                this.state.connectingMode.startObjectiveId = null;
                this.elements.appContainer.classList.remove('connecting-mode');
                this.render();
            },
            
            handleDeleteConnection(connectionId) {
                 this.showConfirmationModal('Verbindung löschen?', 'Möchten Sie diese Verbindung wirklich löschen?', () => {
                    this.state.connections = this.state.connections.filter(c => c.id !== connectionId);
                    this.closeModal();
                    this.saveState();
                    this.render();
                });
            },

            // --- 7. DATENMANIPULATION ---
            handleSaveObjective(perspectiveId, objectiveId) {
                const name = document.getElementById('objectiveName').value.trim();
                const themeId = document.getElementById('objectiveTheme').value;
                if (!name) return;

                if (objectiveId) { // Editing
                    const objective = this.findObjective(objectiveId).objective;
                    objective.name = name;
                    objective.themeId = themeId;
                } else { // Creating
                    const perspective = this.state.perspectives.find(p => p.id === perspectiveId);
                    const newObjective = { id: this.generateUUID(), name, themeId, kpis: [], initiatives: [], description: '' };
                    perspective.objectives.push(newObjective);
                    this.state.selectedObjectiveId = newObjective.id;
                }
                this.closeModal(); this.saveState(); this.render();
            },

            handleSaveKpi(kpiId) {
                const objective = this.getSelectedObjective();
                if(!objective) return;

                const name = document.getElementById('kpiName').value.trim();
                const target = parseFloat(document.getElementById('kpiTarget').value);
                const actual = parseFloat(document.getElementById('kpiActual').value);

                if(name && !isNaN(target) && !isNaN(actual)) {
                    if (!objective.kpis) objective.kpis = [];
                    if (kpiId) { // Editing
                        const kpi = objective.kpis.find(k => k.id === kpiId);
                        kpi.name = name; kpi.target = target; kpi.actual = actual;
                    } else { // Creating
                        objective.kpis.push({ id: this.generateUUID(), name, target, actual });
                    }
                    this.closeModal(); this.saveState(); this.render();
                }
            },

            handleSaveInitiative(initiativeId) {
                const objective = this.getSelectedObjective();
                if (!objective) return;

                const name = document.getElementById('initiativeName').value.trim();
                const responsible = document.getElementById('initiativeResponsible').value.trim();
                const status = document.getElementById('initiativeStatus').value;

                if (name && responsible) {
                    if (!objective.initiatives) objective.initiatives = [];
                    if (initiativeId) { // Editing
                        const initiative = objective.initiatives.find(i => i.id === initiativeId);
                        initiative.name = name; initiative.responsible = responsible; initiative.status = status;
                    } else { // Creating
                        objective.initiatives.push({ id: this.generateUUID(), name, responsible, status });
                    }
                    this.closeModal(); this.saveState(); this.renderDetailsPanel();
                }
            },

            handleDeleteObjective(objectiveId) {
                this.showConfirmationModal('Ziel löschen?', 'Sind Sie sicher, dass Sie dieses Ziel und alle zugehörigen Daten (KPIs, Initiativen) löschen möchten?', () => {
                    this.state.perspectives.forEach(p => { p.objectives = p.objectives.filter(o => o.id !== objectiveId); });
                    this.state.connections = this.state.connections.filter(c => c.from !== objectiveId && c.to !== objectiveId);
                    if (this.state.selectedObjectiveId === objectiveId) this.state.selectedObjectiveId = null;
                    this.closeModal(); this.saveState(); this.render();
                });
            },

            showModal(saveCallback) {
                this.lastFocusedElement = document.activeElement;
                this.elements.modal.style.display = 'flex';
                this.elements.modalSave.onclick = saveCallback;
                // Focus trap logic can be added here
            },
            
            showConfirmationModal(title, text, onConfirm) {
                this.elements.modalTitle.textContent = title;
                this.elements.modalBody.innerHTML = `<p>${text}</p>`;
                this.showModal(onConfirm);
            },

            closeModal() {
                this.elements.modal.style.display = 'none';
                this.elements.modalBody.innerHTML = '';
                this.elements.modalSave.onclick = null;
                if (this.lastFocusedElement) this.lastFocusedElement.focus();
            },
            
            highlightConnections(objectiveId, isHighlighted) {
                this.lines.forEach(lineInfo => {
                    if (lineInfo.from === objectiveId || lineInfo.to === objectiveId) {
                        lineInfo.line.setOptions({
                            size: isHighlighted ? 4 : 2,
                            color: isHighlighted ? 'var(--color-accent-info)' : 'rgba(52, 58, 64, 0.6)'
                        });
                    }
                });
            },

            // --- 8. PERSISTENZ & DEFAULTS ---
            checkStorage() {
                try {
                    localStorage.setItem('test', 'test');
                    localStorage.removeItem('test');
                    this.isStorageAvailable = true;
                } catch (e) {
                    this.isStorageAvailable = false;
                    console.warn("localStorage is not available. Progress will not be saved.");
                    // Disable UI elements that require storage
                    this.elements.exportJsonBtn.disabled = true;
                    this.elements.importJsonBtn.disabled = true;
                }
            },
            saveState() {
                if (!this.isStorageAvailable) return;
                try {
                    localStorage.setItem('bscState', JSON.stringify(this.state));
                } catch (e) {
                    console.error("Error saving state to localStorage:", e);
                }
            },

            loadState() {
                if (!this.isStorageAvailable) return false;
                try {
                    const savedState = localStorage.getItem('bscState');
                    if (savedState) {
                        this.state = JSON.parse(savedState);
                        return true;
                    }
                } catch (e) {
                    console.error("Error loading state from localStorage:", e);
                }
                return false;
            },

            resetStateToDefaults() {
                const t1 = {id: this.generateUUID(), name: 'Wachstum', color: '#28a745'};
                const t2 = {id: this.generateUUID(), name: 'Effizienz', color: '#17a2b8'};

                const o1 = { id: this.generateUUID(), name: 'Profitabilität steigern', themeId: t2.id, kpis: [{id: this.generateUUID(), name: 'Umsatzrendite', target: 15, actual: 12}], initiatives: [], description: 'Steigerung der Marge durch Effizienzprogramme.' };
                const o2 = { id: this.generateUUID(), name: 'Umsatzwachstum', themeId: t1.id, kpis: [], initiatives: [], description: '' };
                const o3 = { id: this.generateUUID(), name: 'Kundenbindung erhöhen', themeId: t1.id, kpis: [{id: this.generateUUID(), name: 'Net Promoter Score', target: 60, actual: 45}], initiatives: [], description: '' };
                const o4 = { id: this.generateUUID(), name: 'Produktqualität verbessern', themeId: t2.id, kpis: [], initiatives: [], description: '' };
                const o5 = { id: this.generateUUID(), name: 'Mitarbeiterkompetenz fördern', themeId: t2.id, kpis: [], initiatives: [], description: '' };

                this.state = {
                    themes: [t1, t2],
                    perspectives: [
                        { id: 'p1', name: 'Finanzperspektive', objectives: [o1, o2] },
                        { id: 'p2', name: 'Kundenperspektive', objectives: [o3] },
                        { id: 'p3', name: 'Prozessperspektive', objectives: [o4] },
                        { id: 'p4', name: 'Lern- & Entwicklungsperspektive', objectives: [o5] }
                    ],
                    connections: [
                        { from: o5.id, to: o4.id, id: this.generateUUID() },
                        { from: o4.id, to: o3.id, id: this.generateUUID() },
                        { from: o3.id, to: o1.id, id: this.generateUUID() },
                        { from: o3.id, to: o2.id, id: this.generateUUID() }
                    ],
                    selectedObjectiveId: null,
                    activeTab: 'kpis',
                    connectingMode: { active: false, startObjectiveId: null }
                };
                this.saveState();
            },

            // --- 9. IMPORT / EXPORT ---
            exportStateAsJson() {
                const dataStr = JSON.stringify(this.state, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = 'bsc-dashboard-export.json';
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            },

            importStateFromJson(event) {
                const fileReader = new FileReader();
                fileReader.onload = (e) => {
                    try {
                        const newState = JSON.parse(e.target.result);
                        if (newState.perspectives && newState.connections && newState.themes) {
                            this.state = newState;
                            this.saveState();
                            this.render();
                        } else {
                            alert('Die JSON-Datei scheint kein valides BSC-Dashboard-Format zu haben.');
                        }
                    } catch (error) {
                        alert('Fehler beim Parsen der JSON-Datei.');
                        console.error(error);
                    }
                };
                fileReader.readAsText(event.target.files[0]);
                event.target.value = '';
            }
        };

        App.init();
    });
    </script>
</body>
</html>
